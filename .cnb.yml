# .cnb.yml
$:
  # vscode äº‹ä»¶ï¼šä¸“ä¾›é¡µé¢ä¸­å¯åŠ¨è¿œç¨‹å¼€å‘ç”¨
  vscode:
    - runner:
        # è‡ªå®šä¹‰CPUæ ¸å¿ƒæ•°,æœ€å¤§æ”¯æŒ64æ ¸
        cpus: 64
      docker:
        # è‡ªå®šä¹‰å¼€å‘çŽ¯å¢ƒ
        build:
          # æŒ‡å®šæž„å»ºé•œåƒçš„ Dockerfile æ–‡ä»¶
          dockerfile: .ide/Dockerfile
      services:
        # å£°æ˜Žä½¿ç”¨ vscode æœåŠ¡
        - vscode
        # å£°æ˜Žåœ¨å®¹å™¨ä¸­æ”¯æŒ docker å‘½ä»¤
        - docker
      stages:
        - name: çŽ¯å¢ƒå¯åŠ¨æ—¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
          script:
        # å®‰è£…pnpmå¹¶ä½¿ç”¨pnpmå®‰è£…ä¾èµ–
            - npm install -g pnpm
            - pnpm i
            - pnpm docs:dev

# äº‘åŽŸç”Ÿæž„å»ºæµç¨‹å’Œè‡ªåŠ¨éƒ¨ç½²
# mainæ”¹æˆæ‚¨å®žé™…çš„åˆ†æ”¯åç§°
main:
  push:
    - runner:
        cpus: 16
      services:
        - docker
        - git-clone-yyds
    - imports: https://cnb.cool/W3C/Flumina/secret/-/blob/main/env.yml
      settings:
        user: ${SSH_USER} # SSHç”¨æˆ·åï¼ˆä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–ï¼Œé¿å…ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ï¼‰
        key: ${SSH_KEY} # SSHç§é’¥ï¼ˆç”¨äºŽå…å¯†ç™»å½•ç›®æ ‡æœåŠ¡å™¨ï¼Œä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–ï¼‰
        port: 22 # SSHç«¯å£ï¼ˆé»˜è®¤22ï¼‰
        hosts:
          - 666.666.666.666 # ç›®æ ‡æœåŠ¡å™¨IPï¼ˆè¦éƒ¨ç½²åˆ°çš„æœåŠ¡å™¨åœ°å€ï¼Œå®žé™…æ›¿æ¢è‡ªå·±çš„æœåŠ¡å™¨IPï¼‰
        source: docs/.vitepress/dist/ # å¾…åŒæ­¥çš„æœ¬åœ°æ–‡ä»¶ç›®å½•ï¼ˆé˜¶æ®µ3æž„å»ºå‡ºçš„é™æ€æ–‡ä»¶
        target: /root/rsync/flumina-blog/dist/ # ç›®æ ‡æœåŠ¡å™¨ä¸Šçš„å­˜æ”¾è·¯å¾„
        delete: true # åŒæ­¥æ—¶åˆ é™¤ç›®æ ‡è·¯å¾„ä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆç¡®ä¿ç›®æ ‡ä¸Žæœ¬åœ°å®Œå…¨ä¸€è‡´ï¼Œé¿å…å†—ä½™æ–‡ä»¶ï¼‰
      docker:
        image: docker.cnb.cool/znb/images/node:18
        volumes:
          - /data/.cache:copy-on-write #å£°æ˜Žå¼çš„æž„å»ºç¼“å­˜
      stages:
        - name: æž„å»ºå½“å‰é¡¹ç›®
          script: echo -n $(date "+%Y-%m-%d %H:%M")
          exports:
            info: CUSTOM_ENV_DATE_INFO
        - name: ðŸ  è®¾ç½®æ·˜å®æº
          script: |
            npm config set registry https://registry.npmmirror.com
        - name: ðŸ–¨ï¸ æ‰“å°çŽ¯å¢ƒ
          # if: |
          #   [ "$CNB_COMMIT_MESSAGE_TITLE" = "BUILD" ]
          script: |
            npm install -g pnpm && node -v && npm -v && yarn -v && pnpm -v
        - name: ðŸ’¡ å®‰è£…ä¾èµ– 
          # if: |
          #   [ "$CNB_COMMIT_MESSAGE_TITLE" = "BUILD" ]
          script: |
            pnpm install
        - name: ðŸ“¦ï¸ ç¼–è¯‘é¡¹ç›®
          # if: |
          #   [ "$CNB_COMMIT_MESSAGE_TITLE" = "BUILD" ]
          script: |
            pnpm docs:build   # VitePress ä¸“ç”¨å‘½ä»¤    
        - name: ðŸšš éƒ¨ç½²åˆ°Pages
          # if: |
          #   [ "$CNB_COMMIT_MESSAGE_TITLE" = "BUILD" ]
          image: node:22
          script: npx edgeone pages deploy ./docs/.vitepress/dist --name flumina-blog --token $EDGEONE_PAGES_API_TOKEN


        #åŒæ­¥ä»“åº“åˆ°gitee                  
        - name: sync to gitee
          image: tencentcom/git-sync
          settings:
            branch: master
            auth_type: https
            username: ${GIT_USERNAME}
            password: ${GIT_ACCESS_TOKEN}
            target_url: https://github.com/sunyzhi55/vitepress-teek-blog.git
            # git_email: 'github-actions[bot]@users.noreply.github.com'


        # å‘å¸ƒé€šçŸ¥åˆ°é’‰é’‰
        - name: ðŸ“¢ å‘å¸ƒé€šçŸ¥åˆ°é’‰é’‰
          image: tencentcom/dingtalk-bot-msg:latest
          settings:
            secret: $SECRET  # æ·»åŠ é’‰é’‰æœºå™¨äººçš„ç­¾åå¯†é’¥
            webhook: $WEBHOOK  # å¡«å†™é’‰é’‰æœºå™¨äººçš„Webhookåœ°å€å˜é‡
            at: "199********" # å¤šä¸ªç”¨åˆ†å·(;)åˆ†éš”
            isAtAll: true
            debug: true # æ–°å¢ž: æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
            c_type: "markdown" # æ”¯æŒ: text, markdown, link, actionCard, multiActionCard, feedCard
            content: |
              > **ðŸŽ‰ ðŸ”¥Flumina Blog åˆä¸€æ¬¡å‘å¸ƒæˆåŠŸå•¦ï¼**   
              > **æž„å»ºæ—¶é—´:** $CUSTOM_ENV_DATE_INFO          
              > **æž„å»ºid:** $CNB_BUILD_ID  
              > **æäº¤id:** $CNB_COMMIT_SHORT            
              > **æž„å»ºåˆ†æ”¯:** $CNB_BRANCH            
              > **æäº¤ä¿¡æ¯:** $CNB_COMMIT_MESSAGE_TITLE            
              > **æäº¤è€…:** $CNB_COMMITTER            
              > **ä»“åº“åœ°å€:** [$CNB_REPO_URL_HTTPS]($CNB_REPO_URL_HTTPS)            
              > **æˆ‘çš„ä¸»é¡µ:** [github.com/sunyzhi55](https://github.com/sunyzhi55)            
